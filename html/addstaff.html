<html>
    <script src="static/jquery.js" type="text/javascript"></script>
    <script src="static/adapter.js" type="text/javascript"></script>
    <script src="static/jquery.blockUI.js" type="text/javascript"></script>
    <head>
        <style>
            body{TEXT-ALIGN: center;}
            div.transbox
            {
                width:130px;
                height:180px;
                position:absolute; 
                top:30px;
                left:105px;
                float:left;
                border:3px solid red;
                opacity:0.6;
                filter:alpha(opacity=60);
            }
            div.mainbox
            {
                width:350px; 
                height:350px; 
                position:relative; 
                MARGIN-RIGHT: auto; 
                MARGIN-LEFT: auto;
                display:none; 
                cursor: default;
            }
        </style>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>Add Staff</title>
    </head>
    <body>
        <hr />

        <table align="center">
        <tr><td>姓名：</td><td><input type="text" name="name" id="name" ></td></tr>
        <tr><td>员工编号：</td><td><input type="text" name="sid" id="sid" ></td></tr>
        <tr><td>身份证号：</td><td><input type="text" name="id" id="id" ></td></tr>
        <tr><td>年龄：</td><td><input type="text" name="age" id="age" ></td></tr>
        <tr><td>脸部图片：</td>
            <td>
                <table align="center">
                    <tr align="center"><td><div id="final_photo" style="display:none; cursor: default"></div></td></tr>
                    <tr align="center"><td><button id="get_photo">点击拍照</button></td></tr>
                </table>
            </td>
        </tr>
        </table>

        <hr />
        <table align="center">
        <tr>
        <td colspan=2 align="center"><button id="upload" onclick="upload()" style="height: 30; width: 130px"><font size="5px">提交</font></button></td>
        </tr>
        </table>

        <script type="text/javascript"> 
        $(document).ready(function() { 
     
            $('#get_photo').click(function() { 
                if ($("#sid").val().length == 0) {
                    alert("请先填写个人信息！");
                    return false;
                }
                $.blockUI({ message: $('#camera'), css: { width: '360px' } }); 
            }); 
     
            $('#confirm').click(function() { 
                // update the block message 
                $.blockUI({ message: "<h1>Remote call in progress...</h1>" }); 
     
                $.ajax({ 
                    url: 'wait.php', 
                    cache: false, 
                    complete: function() { 
                        // unblock when remote call returns 
                        $.unblockUI(); 
                    } 
                }); 
            }); 
     
            $('#close_camera').click(function() { 
                $.unblockUI(); 
                return false; 
            }); 
     
        }); 
        </script> 

         <script>
            
            // 拍照上传返回人脸并显示
            function getPic() {
                var canvas = document.getElementById("canvas"); 
                var ctx = canvas.getContext("2d"); 
                ctx.drawImage(video_element, 0, 0, 320, 240);

                var imgData = canvas.toDataURL("image/jpg");
                var data = imgData.substr(22);  //截取22位以后的字符串作为图像数据
                var length = atob(data).length; // atob decodes a string of data which has been encoded using base-64 encoding
                var ssid = $("#sid").val();
                $.post('/upload_image',{ 'pic':data, 'sid':ssid }, 
                        function(msg){
                        if (msg == 'success') {
                            $("#face").html("<p><h3>Your Face:</h3>" + "<img src='static/records/faces/" + ssid +"_tmp.jpg'></p>" + "<hr /><p><input type='button' id='confirm' value='确认' style='height: 25px; width: 50px'/>" + "<input type='button' id='close_face' value='返回' style='height: 25px; width: 50px'/></p>");
                            // $("#face").show();
                            $(document).ready(function() { 
                                 $.blockUI({ message: $('#face'), css: { width: '180' } });
                                 $('#close_face').click(function() { 
                                     $.blockUI({ message: $('#camera'), css: { width: '360px' } });
                                     return false;
                                });
                                 $('#confirm').click(function() { 
                                    $.unblockUI(); 
                                    $("#final_photo").html("<img src='static/faces/" + ssid +"_tmp.jpg'>");
                                    $("#final_photo").show();
                                    return true;
                                });
                            });
                        }
                        else {
                            alert("人脸捕获失败，请重新拍照");
                        }
                        });
            }
            // 提交其他信息
            function upload() {
                var sname = $("#name").val();
                if (sname.length == 0) {
                    alert("姓名不能为空！");
                    return false;
                }
                var ssid = $("#sid").val();
                if (ssid.length == 0) {
                    alert("员工编号不能为空！");
                    return false;
                }
                var sid = $("#id").val();
                if (sid.length == 0) {
                    alert("身份证号不能为空！");
                    return false;
                }
                var sage = $("#age").val();
                if (sage.length == 0) {
                    alert("年龄不能为空！");
                    return false;
                }
                var final_photo_div = document.getElementById("final_photo");
                if (final_photo_div.style.display == "none") {
                    alert("需要您的照片！");
                    return false;
                }
                $.post('/add_new_staff',{ 'name':sname, 'age':sage, 'id':sid, 'sid':ssid }, 
                        function(msg){
                        if (msg == 'success') {
                            // $("#result").attr("value",'成功');
                            alert("成功");           
                        }
                        else {
                            // $("#result").attr("value",'失败，请重试');
                        }
                        });
            }
        </script>
    <div class="mainbox" id="camera" style="display:none; cursor: default"> 
        <table align="center">
        <tr align="center"><td><video id="video" width="320" height="240" autoplay=""></video></td></tr>
        <tr><td><canvas id="canvas" width="320" height="240" style="display:none"></canvas></td></tr>
        <tr align="center">
        <td><button id="snap" onclick="getPic()" style="height: 25px; width: 80px"><font size="2px">拍照</font></button></td>
        </tr>
        <tr align="center">
        <td><button id="close_camera" style="height: 25px; width: 80px"><font size="2px">关闭</font></button></td>
        </tr>
        <tr align="center"><td><font color="blue">请将您的面部<font color="red">正对</font>并置于红色框内，并使面部轮廓尽量与红色框重合</font></td></tr>
        </table>
        <script>
        var video_element = document.getElementById('video');
            var constraints = {"mandatory": {}, "optional": []}; 
            getUserMedia({'audio':false, 'video':constraints}, onUserMediaSuccess, onUserMediaError);
            function onUserMediaSuccess(stream) {
                attachMediaStream(video_element, stream);
                video_element.style.opacity = 1;
              }
            function onUserMediaError(error) {
                alert("Failed to get access to local media. Error code was " + error.code + ".");
            }
        </script>
        <div class="transbox" id="box"></div>
    </div> 

    <div id="face" style="display:none; cursor: default"></div>

    </body>
</html>
