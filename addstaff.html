<html>
    <script src="static/jquery.js" type="text/javascript"></script>
    <script src="static/adapter.js" type="text/javascript"></script>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>Add Staff</title>
    </head>
    <body>
        <hr />
        <table align="center"><tr>

        <td><table align="center">
        <tr align="center"><td><video id="video" width="240" height="240" autoplay=""></video></td></tr>
        <tr><td><canvas id="canvas" width="320" height="240" style="display:none"></canvas></td></tr>
        <tr align="center">
        <td><button id="snap" onclick="getPic()" style="height: 25px; width: 100px"><font size="3px">拍照</font></button></td>
        </tr>
        </table><td>

        <td><table align="center">
        <tr><td>姓名：</td><td><input type="text" name="name" id="name" ></td></tr>
        <tr><td>年龄：</td><td><input type="text" name="age" id="age" ></td></tr>
        <tr><td>身份证号：</td><td><input type="text" name="id" id="id" ></td></tr>
        <tr><td>员工编号：</td><td><input type="text" name="sid" id="sid" ></td></tr>
        <tr><td>脸部图片（点击拍照以捕获）：</td><td><div id="face"></div></td></tr>
        </table></td>
        
        </tr></table>

        <hr />
        <table align="center">
        <tr>
        <td colspan=2 align="center"><button id="upload" onclick="upload()" style="height: 30; width: 130px"><font size="5px">提交</font></button></td>
        </tr>
        </table>

         <script>
            var video_element = document.getElementById('video');
            var constraints = {"mandatory": {}, "optional": []}; 
            getUserMedia({'audio':false, 'video':constraints}, onUserMediaSuccess, onUserMediaError);
            function onUserMediaSuccess(stream) {
                attachMediaStream(video_element, stream);
                video_element.style.opacity = 1;
              }
            function onUserMediaError(error) {
                alert("Failed to get access to local media. Error code was " + error.code + ".");
            }
            // 拍照上传返回人脸并显示
            function getPic() {
                var canvas = document.getElementById("canvas"); 
                var ctx = canvas.getContext("2d"); 
                ctx.drawImage(video_element, 0, 0, 320, 240);

                var imgData = canvas.toDataURL("image/jpg");
                var data = imgData.substr(22);  //截取22位以后的字符串作为图像数据
                var length = atob(data).length; // atob decodes a string of data which has been encoded using base-64 encoding
                var ssid = $("#sid").val();
                $.post('/upload_image',{ 'pic':data, 'sid':ssid }, 
                        function(msg){
                        if (msg == 'success') {
                            $("#face").html("捕获到您的人脸：");
                            $("#face").html("<img src='static/faces/" + ssid +"_tmp.jpg'>");
                            $("#face").show();
                        }
                        else {
                            alert("人脸捕获失败，请重新拍照");
                        }
                        });
            }
            // 提交其他信息
            function upload() {
                var sname = $("#name").val();
                var sage = $("#age").val();
                var sid = $("#id").val();
                var ssid = $("#sid").val();
                $.post('/add_new_staff',{ 'name':sname, 'age':sage, 'id':sid, 'sid':ssid }, 
                        function(msg){
                        if (msg == 'success') {
                            // $("#result").attr("value",'成功');
                            alert("成功");           
                        }
                        else {
                            // $("#result").attr("value",'失败，请重试');
                        }
                        });
            }
        </script>

    </body>
</html>
